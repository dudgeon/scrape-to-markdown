import"./modulepreload-polyfill-B5Qt9EMX.js";import{p as q}from"./url-parser-DW0nA-39.js";import{c as H}from"./clip-page-Cuq5VKz1.js";import{i as j,E as G,g as z,c as W,s as S}from"./frontmatter-WWy6V-3-.js";import"./constants-I65fpLFJ.js";j(new G);const a=document.getElementById("status"),J=document.getElementById("controls"),K=document.getElementById("channel-name"),Q=document.getElementById("message-count"),i=document.getElementById("copy-btn"),u=document.getElementById("download-btn"),T=document.getElementById("result"),b=document.getElementById("result-message"),C=document.getElementById("error"),V=document.getElementById("error-text"),P=document.getElementById("retry-btn"),h=document.getElementById("progress"),y=document.getElementById("progress-fill"),E=document.getElementById("progress-text"),X=document.getElementById("last-n-options"),Y=document.getElementById("date-range-options"),w=document.getElementById("date-from"),f=document.getElementById("date-to"),Z=document.getElementById("include-threads"),ee=document.getElementById("include-reactions"),te=document.getElementById("include-files"),ne=document.getElementById("include-frontmatter"),p=document.getElementById("frontmatter-settings");p==null||p.addEventListener("click",e=>{e.preventDefault(),chrome.runtime.openOptionsPage()});const oe=document.getElementById("clip-controls"),R=document.getElementById("clip-page-title"),le=document.getElementById("clip-include-frontmatter"),I=document.getElementById("clip-copy-btn"),v=document.getElementById("clip-download-btn"),O=document.getElementById("clip-result"),L=document.getElementById("clip-result-message"),$=document.getElementById("clip-progress"),F=document.getElementById("clip-progress-fill"),U=document.getElementById("clip-progress-text"),g=document.getElementById("clip-frontmatter-settings");g==null||g.addEventListener("click",e=>{e.preventDefault(),chrome.runtime.openOptionsPage()});let k=null,B=null,M=null,x=null,d="",s="",m=null;const D=document.querySelector(".version");D&&(D.textContent="v0.2.0");const ce=document.querySelectorAll('input[name="scope"]');ce.forEach(e=>{e.addEventListener("change",()=>{const t=e.value;X.classList.toggle("hidden",t!=="last_n"),Y.classList.toggle("hidden",t!=="date_range")})});chrome.runtime.onMessage.addListener(e=>{if(e.type!=="PROGRESS")return;h.classList.remove("hidden");const o={fetching:"Fetching messages",resolving_users:"Resolving users",fetching_threads:"Fetching threads",converting:"Converting to markdown"}[e.phase]||e.phase;if(e.total){const l=Math.round(e.current/e.total*100);y.style.width=`${l}%`,E.textContent=`${o}: ${e.current}/${e.total}`}else y.style.width="",E.textContent=e.current>0?`${o} (page ${e.current})...`:`${o}...`});function se(){const e=document.querySelector('input[name="scope"]:checked').value;if(e==="date_range"){const t=w.value?new Date(w.value).getTime()/1e3:0,o=f.value?new Date(f.value+"T23:59:59").getTime()/1e3:Date.now()/1e3;return{mode:"date_range",oldest:t,latest:o}}return e==="all"?{mode:"all"}:{mode:"last_n",count:parseInt(Q.value,10)}}async function _(){if(!k)return null;T.classList.add("hidden"),C.classList.add("hidden"),h.classList.remove("hidden"),y.style.width="0%",E.textContent="Starting...",i.disabled=!0,u.disabled=!0;try{const e=await chrome.runtime.sendMessage({type:"FETCH_MESSAGES",channelId:k,scope:se(),includeThreads:Z.checked,includeReactions:ee.checked,includeFiles:te.checked,includeFrontmatter:ne.checked});return!e.success||!e.markdown?(r(e.error||"Export failed",e.errorCategory),null):(M=e.markdown,b.textContent=`Exported ${e.messageCount} messages`,T.classList.remove("hidden"),e.markdown)}catch(e){return r(e instanceof Error?e.message:"Unknown error"),null}finally{h.classList.add("hidden"),i.disabled=!1,u.disabled=!1}}i.addEventListener("click",async()=>{m="copy";const e=await _();e&&(await navigator.clipboard.writeText(e),b.textContent+=" — copied to clipboard!")});u.addEventListener("click",async()=>{m="download";const e=await _();if(!e)return;const t=B?`${B}-${new Date().toISOString().split("T")[0]}.md`:`slack-export-${new Date().toISOString().split("T")[0]}.md`,o=new Blob([e],{type:"text/markdown"}),l=URL.createObjectURL(o),n=document.createElement("a");n.href=l,n.download=t,n.click(),URL.revokeObjectURL(l),b.textContent+=" — downloaded!"});async function N(){if(!x)return null;O.classList.add("hidden"),C.classList.add("hidden"),$.classList.remove("hidden"),F.style.width="50%",U.textContent="Extracting article...",I.disabled=!0,v.disabled=!0;try{const[e]=await chrome.scripting.executeScript({target:{tabId:x},func:()=>{let l;const n=window.getSelection();if(n&&n.rangeCount>0&&!n.isCollapsed){const c=document.createElement("div");c.appendChild(n.getRangeAt(0).cloneContents()),l=c.innerHTML}return{html:document.documentElement.outerHTML,url:location.href,title:document.title,selectedHtml:l}}});if(!(e!=null&&e.result))return r("Could not read page content."),null;F.style.width="80%",U.textContent="Converting to markdown...";const t=H(e.result);let o=t.markdown;if(le.checked){const l={title:t.title,sourceUrl:d,author:t.byline,siteName:t.siteName,excerpt:t.excerpt};let n;try{const c=await z("web");c?n=W(c,l):n=S({title:t.title,source:"web-clip",source_url:d,author:t.byline||"",captured:new Date().toISOString(),tags:["web-clip"]})}catch{n=S({title:t.title,source:"web-clip",source_url:d,captured:new Date().toISOString(),tags:["web-clip"]})}o=n+`

`+o}return M=o,s=t.title||s,L.textContent=e.result.selectedHtml?"Clipped selection":"Clipped article",O.classList.remove("hidden"),o}catch(e){return r(e instanceof Error?e.message:"Clip failed"),null}finally{$.classList.add("hidden"),I.disabled=!1,v.disabled=!1}}I.addEventListener("click",async()=>{const e=await N();e&&(await navigator.clipboard.writeText(e),L.textContent+=" — copied to clipboard!")});v.addEventListener("click",async()=>{const e=await N();if(!e)return;const o=`${s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"").slice(0,60)||"clip"}-${new Date().toISOString().split("T")[0]}.md`,l=new Blob([e],{type:"text/markdown"}),n=URL.createObjectURL(l),c=document.createElement("a");c.href=n,c.download=o,c.click(),URL.revokeObjectURL(n),L.textContent+=" — downloaded!"});function r(e,t){V.textContent=t==="auth"?"Session expired. Please refresh Slack and try again.":e,P.classList.toggle("hidden",t!=="transient"),C.classList.remove("hidden")}P.addEventListener("click",()=>{m==="copy"?i.click():m==="download"&&u.click()});async function re(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0}),t=(e==null?void 0:e.url)||"",o=q(t),l={type:"GET_STATUS",...o&&{channelId:o.channelId,workspaceId:o.workspaceId}};if(!o){x=(e==null?void 0:e.id)??null,d=t,s=(e==null?void 0:e.title)||t,R.textContent=s,R.title=t,a.classList.add("hidden"),oe.classList.remove("hidden");return}const n=await chrome.runtime.sendMessage(l);if(!n.hasToken){a.textContent="No Slack session detected. Please open Slack and refresh the page.";return}if(!n.channelId){a.textContent="Please navigate to a Slack channel.";return}k=n.channelId,B=n.channelName||null,K.textContent=n.channelName?`#${n.channelName}`:n.channelId;const c=new Date,A=new Date(c.getTime()-7*24*60*60*1e3);f.value=c.toISOString().split("T")[0],w.value=A.toISOString().split("T")[0],a.classList.add("hidden"),J.classList.remove("hidden")}catch{r("Failed to connect to extension. Try reloading the page.")}}re();
