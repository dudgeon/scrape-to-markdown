var V=Object.defineProperty;var ee=(e,t,r)=>t in e?V(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var L=(e,t,r)=>ee(e,typeof t!="symbol"?t+"":t,r);import{a as te,A as $,b as N,S as p}from"./constants-I65fpLFJ.js";import{g as K,b as re,a as U,c as ne,s as ae,i as se,E as ce,d as oe}from"./frontmatter-WWy6V-3-.js";const ie={maxRetries:3,baseDelay:1e3,maxDelay:3e4,shouldRetry:()=>!0,getRetryAfter:()=>{}};async function S(e,t={}){const r={...ie,...t};let n;for(let a=0;a<=r.maxRetries;a++)try{return await e()}catch(s){if(n=s,a>=r.maxRetries||!r.shouldRetry(s))throw s;const i=r.getRetryAfter(s)??Math.min(r.maxDelay,r.baseDelay*Math.pow(2,a)*(.5+Math.random()*.5));await new Promise(l=>setTimeout(l,i))}throw n}let R,W;function le(e,t){R=e,W=t}class A extends Error{constructor(t,r){super(t),this.slackError=r,this.name="SlackApiError"}}class q extends A{constructor(t){super("Your Slack session has expired. Please refresh Slack and try again.",t),this.name="SlackAuthError"}}class _ extends A{constructor(r,n,a){super(r,n);L(this,"retryAfterMs");this.name="SlackTransientError",this.retryAfterMs=a}}function ue(e){return e instanceof _}function fe(e){if(e instanceof _)return e.retryAfterMs}const k={maxRetries:3,baseDelay:1e3,maxDelay:3e4,shouldRetry:ue,getRetryAfter:fe};async function T(e,t){const r=await R.getToken();if(!r)throw new A("No token available. Open Slack and refresh the page.");const n=await R.getCookie();if(!n)throw new A("No session cookie found. Make sure you are logged into Slack.");let a;try{a=await W.post(`${te}/${e}`,{Authorization:`Bearer ${r}`,Cookie:n,"Content-Type":"application/x-www-form-urlencoded"},new URLSearchParams(t).toString())}catch(o){throw new _(`Network error calling ${e}: ${o instanceof Error?o.message:String(o)}`)}if(a.status===429){a.ok;let o;try{const i=await a.json();i.retry_after&&(o=i.retry_after*1e3)}catch{}throw new _(`Rate limited by Slack API (${e})`,"ratelimited",o??5e3)}const s=await a.json();if(!s.ok)throw s.error==="invalid_auth"||s.error==="token_revoked"?(await R.clearToken(),new q(s.error)):s.error==="internal_error"||s.error==="fatal_error"?new _(`Slack API error: ${s.error}`,s.error):new A(`Slack API error: ${s.error}`,s.error);return s}function D(e){return new Promise(t=>setTimeout(t,e))}async function de(e,t={}){var i,l;const r=[];let n;const a=t.limit;let s=0,o=0;do{const g=a?Math.min($,a-s):$,c={channel:e,limit:String(g),inclusive:"true"};t.oldest&&(c.oldest=t.oldest),t.latest&&(c.latest=t.latest),n&&(c.cursor=n);const h=await S(()=>T("conversations.history",c),k);if(r.push(...h.messages),s+=h.messages.length,n=((i=h.response_metadata)==null?void 0:i.next_cursor)||void 0,o++,(l=t.onPage)==null||l.call(t,o),a&&s>=a)break;n&&await D(N)}while(n);return r.reverse(),a&&r.length>a?r.slice(r.length-a):r}async function he(e,t){var a;const r=[];let n;do{const s={channel:e,ts:t,limit:String($)};n&&(s.cursor=n);const o=await S(()=>T("conversations.replies",s),k);r.push(...o.messages),n=((a=o.response_metadata)==null?void 0:a.next_cursor)||void 0,n&&await D(N)}while(n);return r}async function Y(e){var n,a;const r=(await S(()=>T("conversations.info",{channel:e}),k)).channel;return{id:r.id,name:r.name,is_channel:r.is_channel,is_group:r.is_group,is_im:r.is_im,is_mpim:r.is_mpim,is_private:r.is_private,topic:((n=r.topic)==null?void 0:n.value)||"",purpose:((a=r.purpose)==null?void 0:a.value)||""}}async function me(){const e=await S(()=>T("team.info",{}),k);return{name:e.team.name,domain:e.team.domain}}async function pe(e){const t=await S(()=>T("users.info",{user:e}),k),r=t.user.profile;return{displayName:r.display_name||r.real_name||t.user.real_name||e}}async function ge(e){var n;const t=[];let r;do{const a={channel:e,limit:String($)};r&&(a.cursor=r);const s=await S(()=>T("conversations.members",a),k);t.push(...s.members),r=((n=s.response_metadata)==null?void 0:n.next_cursor)||void 0,r&&await D(N)}while(r);return t}let O,v={},H=!1;function we(e){O=e}async function ye(){H||(v=await O.get(p.USER_CACHE)||{},H=!0)}async function _e(){await O.set(p.USER_CACHE,v)}async function I(e){await ye();const t={},r=[];for(const n of e)v[n]?t[n]=v[n]:r.push(n);for(const n of r){const a=await pe(n);v[n]=a.displayName,t[n]=a.displayName}return r.length>0&&await _e(),t}class Se{async getToken(){return(await chrome.storage.session.get(p.TOKEN))[p.TOKEN]}async getCookie(){const t=await chrome.cookies.get({url:"https://app.slack.com",name:"d"});return t?`d=${t.value}`:void 0}async clearToken(){await chrome.storage.session.remove(p.TOKEN)}}class ke{async post(t,r,n){return fetch(t,{method:"POST",headers:r,body:n})}}function Te(e,t){return e.elements.map(r=>Ee(r,t)).join(`

`)}function Ee(e,t){switch(e.type){case"rich_text_section":return z(e,t);case"rich_text_list":return xe(e,t);case"rich_text_preformatted":return Ce(e,t);case"rich_text_quote":return Ae(e,t);default:return""}}function z(e,t){return e.elements.map(r=>F(r,t)).join("")}function xe(e,t){const r="  ".repeat(e.indent||0);return e.elements.map((n,a)=>{const s=z(n,t),o=e.style==="ordered"?`${a+1}.`:"-";return`${r}${o} ${s}`}).join(`
`)}function Ce(e,t){return"```\n"+e.elements.map(n=>F(n,t)).join("")+"\n```"}function Ae(e,t){return e.elements.map(n=>F(n,t)).join("").split(`
`).map(n=>`> ${n}`).join(`
`)}function F(e,t){switch(e.type){case"text":return B(e.text,e.style);case"link":{const r=e.text?`[${e.text}](${e.url})`:`<${e.url}>`;return e.style?B(r,e.style):r}case"emoji":return`:${e.name}:`;case"user":return`@${t.resolveUser(e.user_id)}`;case"channel":return`#${t.resolveChannel(e.channel_id)}`;case"usergroup":return"@group";case"broadcast":return`@${e.range}`;default:return""}}function B(e,t){if(!t)return e;if(t.code)return`\`${e}\``;let r=e;return t.bold&&t.italic?r=`***${r}***`:t.bold?r=`**${r}**`:t.italic&&(r=`*${r}*`),t.strike&&(r=`~~${r}~~`),r}function X(e,t){let r=e;return r=r.replace(/<@(U[A-Z0-9]+)>/g,(n,a)=>`@${t.resolveUser(a)}`),r=r.replace(/<#(C[A-Z0-9]+)\|([^>]+)>/g,(n,a,s)=>`#${s}`),r=r.replace(/<(https?:\/\/[^|>]+)\|([^>]+)>/g,"[$2]($1)"),r=r.replace(/<(https?:\/\/[^>]+)>/g,"<$1>"),r=r.replace(new RegExp("(?<![`\\\\])\\*([^*\\n]+)\\*(?!`)","g"),"**$1**"),r=r.replace(new RegExp("(?<![`\\\\])_([^_\\n]+)_(?!`)","g"),"*$1*"),r=r.replace(new RegExp("(?<![`\\\\])~([^~\\n]+)~(?!`)","g"),"~~$1~~"),r}function j(e){const t=parseFloat(e)*1e3,r=new Date(t),n=r.toISOString().split("T")[0],a=r.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return{date:n,time:a}}function ve(e,t){return`**${e}** â€” ${t}`}const G=80;function Me(e,t,r,n){const a=n.length>G?n.slice(0,G)+"â€¦":n;return`> **Thread** (${e} ${e===1?"reply":"replies"} to ${t} â€” ${r}: â€œ${a}â€):`}function Re(e){return e.length?`> ${e.map(r=>`:${r.name}: ${r.count}`).join(" Â· ")}`:""}function $e(e){const t=e.permalink||e.url_private;return t?`ðŸ“Ž [${e.name}](${t})`:`ðŸ“Ž ${e.name} (no public URL)`}function Ne(e){return`*${e}*`}function Ie(e,t){const r=new Date().toISOString().split("T")[0];return[`# #${e}`,"",`Exported from Slack Â· ${r} Â· Messages: ${t}`,"","---"].join(`
`)}const Pe=new Set(["channel_join","channel_leave","channel_topic","channel_purpose","channel_name","channel_archive"]);function be(e,t){var i,l,g;const r=c=>t.userMap[c]||c,a={resolveUser:r,resolveChannel:c=>{var h;return((h=t.channelMap)==null?void 0:h[c])||c}},s=[];let o="";t.skipDocumentHeader||s.push(Ie(t.channelName,e.length));for(const c of e){const{date:h,time:E}=j(c.ts);if(h!==o&&(o=h,s.push(`## ${h}`)),c.subtype&&Pe.has(c.subtype)){const u=X(c.text,a);s.push(Ne(u));continue}const x=c.user?r(c.user):c.username||"Unknown";if(s.push(ve(x,E)),s.push(P(c,a)),t.includeReactions&&((i=c.reactions)!=null&&i.length)&&s.push(Re(c.reactions)),t.includeFiles&&((l=c.files)!=null&&l.length))for(const u of c.files)s.push($e(u));if(t.includeThreadReplies&&c.thread_ts===c.ts&&c.reply_count&&c.reply_count>0){const u=(g=t.threadReplies)==null?void 0:g[c.ts];if(u&&u.length>1){const w=P(c,a),f=u.length-1,m=[];m.push(Me(f,x,E,w));for(const d of u.slice(1)){const{time:y}=j(d.ts),M=d.user?r(d.user):d.username||"Unknown";m.push(">"),m.push(`> **${M}** â€” ${y}`);const Z=P(d,a);for(const J of Z.split(`
`))m.push(`> ${J}`)}s.push(m.join(`
`))}}}return s.join(`

`)}function P(e,t){var n;const r=(n=e.blocks)==null?void 0:n.find(a=>a.type==="rich_text");return r?Te(r,t):X(e.text,t)}async function De(e){var g,c,h,E,x;const t={};e.scope.mode==="last_n"?t.limit=e.scope.count:e.scope.mode==="date_range"&&(t.oldest=String(e.scope.oldest),t.latest=String(e.scope.latest)),(g=e.onProgress)==null||g.call(e,{current:0,phase:"fetching"});const r=await de(e.channelId,{...t,onPage:u=>{var w;return(w=e.onProgress)==null?void 0:w.call(e,{current:u,phase:"fetching"})}});(c=e.onProgress)==null||c.call(e,{current:0,phase:"resolving_users"});const n=Oe(r),a=await I(Array.from(n)),s=await Y(e.channelId);let o;if(e.includeThreads){o={};const u=r.filter(f=>f.thread_ts===f.ts&&f.reply_count&&f.reply_count>0);(h=e.onProgress)==null||h.call(e,{current:0,total:u.length,phase:"fetching_threads"});for(let f=0;f<u.length;f++){const m=u[f],d=await he(e.channelId,m.ts);o[m.ts]=d;for(const y of d)y.user&&n.add(y.user);(E=e.onProgress)==null||E.call(e,{current:f+1,total:u.length,phase:"fetching_threads"}),f<u.length-1&&await new Promise(y=>setTimeout(y,N))}const w=await I(Array.from(n));Object.assign(a,w)}(x=e.onProgress)==null||x.call(e,{current:0,phase:"converting"});const i=be(r,{channelName:s.name,userMap:a,includeReactions:e.includeReactions,includeFiles:e.includeFiles,includeThreadReplies:e.includeThreads,threadReplies:o,skipDocumentHeader:e.includeFrontmatter});let l=i;if(e.includeFrontmatter){let u={name:"",domain:""};try{u=await me()}catch{}let w;if(s.is_im||s.is_mpim)try{const d=await ge(e.channelId),y=await I(d);w=d.map(M=>y[M]||M)}catch{}const f={channel:s,workspaceName:u.name,workspaceDomain:u.domain,messages:r,messageCount:r.length,scope:e.scope,participants:w};let m;try{const d=await K("slack");d?m=re(d,f):m=U(f)}catch{m=U(f)}l=m+`

`+i}return{markdown:l,messageCount:r.length}}function Oe(e){const t=new Set;for(const r of e)if(r.user&&t.add(r.user),r.blocks){for(const n of r.blocks)if(n.type==="rich_text"){for(const a of n.elements)if("elements"in a)for(const s of a.elements)s.type==="user"&&t.add(s.user_id)}}return t}const Fe="src/offscreen/offscreen.html";function Le(){chrome.contextMenus.create({id:"s2md-clip-page",title:"Copy page as Markdown",contexts:["page"]}),chrome.contextMenus.create({id:"s2md-clip-selection",title:"Copy selection as Markdown",contexts:["selection"]}),chrome.contextMenus.onClicked.addListener(Ue)}async function Ue(e,t){var r;if(!(!(t!=null&&t.id)||!((r=e.menuItemId)!=null&&r.toString().startsWith("s2md-"))))try{const n=await Q(t.id,t.url||"");if(!n)return;await chrome.scripting.executeScript({target:{tabId:t.id},func:a=>navigator.clipboard.writeText(a),args:[n]}),chrome.action.setBadgeText({text:"MD"}),chrome.action.setBadgeBackgroundColor({color:"#4a6cf7"}),setTimeout(()=>chrome.action.setBadgeText({text:""}),2e3)}catch(n){console.error("[s2md] Context menu clip failed:",n)}}async function Q(e,t){const[r]=await chrome.scripting.executeScript({target:{tabId:e},func:()=>{let o;const i=window.getSelection();if(i&&i.rangeCount>0&&!i.isCollapsed){const l=document.createElement("div");l.appendChild(i.getRangeAt(0).cloneContents()),o=l.innerHTML}return{html:document.documentElement.outerHTML,url:location.href,title:document.title,selectedHtml:o}}});if(!(r!=null&&r.result))return null;await He();const n={type:"CLIP_PAGE_OFFSCREEN",target:"offscreen",pageData:r.result},a=await chrome.runtime.sendMessage(n);if(!a.success)return console.error("[s2md] Clip failed:",a.error),null;let s=a.markdown;try{const o={title:a.title,sourceUrl:t,author:a.byline,siteName:a.siteName,excerpt:a.excerpt},i=await K("web");let l;i?l=ne(i,o):l=ae({title:a.title,source:"web-clip",source_url:t,captured:new Date().toISOString(),tags:["web-clip"]}),s=l+`

`+s}catch{}return s}let C=null;async function He(){if(!((await chrome.runtime.getContexts({contextTypes:[chrome.runtime.ContextType.OFFSCREEN_DOCUMENT]})).length>0)){if(C){await C;return}C=chrome.offscreen.createDocument({url:Fe,reasons:[chrome.offscreen.Reason.DOM_PARSER],justification:"Parse page HTML with DOMParser for Readability article extraction"}),await C,C=null}}le(new Se,new ke);we(new oe);se(new ce);chrome.storage.session.setAccessLevel({accessLevel:"TRUSTED_AND_UNTRUSTED_CONTEXTS"});function b(e){chrome.storage.session.set({[p.TOKEN]:e})}chrome.webRequest.onBeforeSendHeaders.addListener(e=>{var t;if(e.requestHeaders){for(const r of e.requestHeaders)if(r.name.toLowerCase()==="authorization"&&((t=r.value)!=null&&t.startsWith("Bearer xoxc-"))){b(r.value.slice(7));return}}},{urls:["https://slack.com/api/*","https://edgeapi.slack.com/*"]},["requestHeaders"]);chrome.webRequest.onBeforeRequest.addListener(e=>{var n,a,s,o,i,l;const t=(s=(a=(n=e.requestBody)==null?void 0:n.formData)==null?void 0:a.token)==null?void 0:s[0];if(typeof t=="string"&&t.startsWith("xoxc-")){b(t);return}const r=(l=(i=(o=e.requestBody)==null?void 0:o.raw)==null?void 0:i[0])==null?void 0:l.bytes;if(r)try{const g=new TextDecoder().decode(r),c=JSON.parse(g);typeof c.token=="string"&&c.token.startsWith("xoxc-")&&b(c.token)}catch{}},{urls:["https://slack.com/api/*","https://edgeapi.slack.com/*"]},["requestBody"]);Le();chrome.commands.onCommand.addListener(async e=>{if(e==="clip-page")try{const[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(t!=null&&t.id))return;const r=await Q(t.id,t.url||"");if(!r)return;await chrome.scripting.executeScript({target:{tabId:t.id},func:n=>navigator.clipboard.writeText(n),args:[r]}),chrome.action.setBadgeText({text:"MD"}),chrome.action.setBadgeBackgroundColor({color:"#4a6cf7"}),setTimeout(()=>chrome.action.setBadgeText({text:""}),2e3)}catch(t){console.error("[s2md] Keyboard shortcut clip failed:",t)}});chrome.runtime.onMessage.addListener((e,t,r)=>e.target==="offscreen"?!1:(Be(e).then(r),!0));async function Be(e){switch(e.type){case"EXTRACT_TOKEN":return;case"CHANNEL_DETECTED":await chrome.storage.session.set({[p.CHANNEL_ID]:e.channelId,[p.WORKSPACE_ID]:e.workspaceId});return;case"GET_STATUS":return je(e);case"FETCH_MESSAGES":return Ge(e);case"CLIP_PAGE_OFFSCREEN":return;default:return{error:"Unknown message type"}}}async function je(e){const t=await chrome.storage.session.get([p.TOKEN,p.CHANNEL_ID]),r=!!t[p.TOKEN],n=e.channelId||t[p.CHANNEL_ID]||void 0;let a;if(r&&n)try{a=(await Y(n)).name}catch{}return{type:"STATUS_RESPONSE",hasToken:r,channelId:n,channelName:a}}async function Ge(e){try{const t=await De({channelId:e.channelId,scope:e.scope,includeThreads:e.includeThreads??!1,includeReactions:e.includeReactions??!1,includeFiles:e.includeFiles??!1,includeFrontmatter:e.includeFrontmatter??!1,onProgress:r=>{chrome.runtime.sendMessage({type:"PROGRESS",...r}).catch(()=>{})}});return{type:"FETCH_MESSAGES_RESPONSE",success:!0,markdown:t.markdown,messageCount:t.messageCount}}catch(t){let r="permanent";return t instanceof q?r="auth":t instanceof _&&(r="transient"),{type:"FETCH_MESSAGES_RESPONSE",success:!1,error:t instanceof Error?t.message:String(t),errorCategory:r}}}
