import"./modulepreload-polyfill-B5Qt9EMX.js";const c=document.getElementById("status"),k=document.getElementById("controls"),B=document.getElementById("channel-name"),S=document.getElementById("message-count"),l=document.getElementById("copy-btn"),d=document.getElementById("download-btn"),f=document.getElementById("result"),w=document.getElementById("result-message"),r=document.getElementById("error"),i=document.getElementById("progress"),u=document.getElementById("progress-fill"),m=document.getElementById("progress-text"),L=document.getElementById("last-n-options"),x=document.getElementById("date-range-options"),g=document.getElementById("date-from"),h=document.getElementById("date-to"),T=document.getElementById("include-threads"),C=document.getElementById("include-reactions"),b=document.getElementById("include-files"),$=document.getElementById("include-frontmatter"),a=document.getElementById("frontmatter-settings");a==null||a.addEventListener("click",e=>{e.preventDefault(),chrome.runtime.openOptionsPage()});let p=null,E=null,R=null;const I=document.querySelector(".version");I&&(I.textContent="v0.1.0");const F=document.querySelectorAll('input[name="scope"]');F.forEach(e=>{e.addEventListener("change",()=>{const t=e.value;L.classList.toggle("hidden",t!=="last_n"),x.classList.toggle("hidden",t!=="date_range")})});chrome.runtime.onMessage.addListener(e=>{if(e.type!=="PROGRESS")return;i.classList.remove("hidden");const n={fetching:"Fetching messages",resolving_users:"Resolving users",fetching_threads:"Fetching threads",converting:"Converting to markdown"}[e.phase]||e.phase;if(e.total){const o=Math.round(e.current/e.total*100);u.style.width=`${o}%`,m.textContent=`${n}: ${e.current}/${e.total}`}else u.style.width="",m.textContent=e.current>0?`${n} (page ${e.current})...`:`${n}...`});function O(){const e=document.querySelector('input[name="scope"]:checked').value;if(e==="date_range"){const t=g.value?new Date(g.value).getTime()/1e3:0,n=h.value?new Date(h.value+"T23:59:59").getTime()/1e3:Date.now()/1e3;return{mode:"date_range",oldest:t,latest:n}}return e==="all"?{mode:"all"}:{mode:"last_n",count:parseInt(S.value,10)}}async function v(){if(!p)return null;f.classList.add("hidden"),r.classList.add("hidden"),i.classList.remove("hidden"),u.style.width="0%",m.textContent="Starting...",l.disabled=!0,d.disabled=!0;try{const e=await chrome.runtime.sendMessage({type:"FETCH_MESSAGES",channelId:p,scope:O(),includeThreads:T.checked,includeReactions:C.checked,includeFiles:b.checked,includeFrontmatter:$.checked});return!e.success||!e.markdown?(y(e.error||"Export failed"),null):(R=e.markdown,w.textContent=`Exported ${e.messageCount} messages`,f.classList.remove("hidden"),e.markdown)}catch(e){return y(e instanceof Error?e.message:"Unknown error"),null}finally{i.classList.add("hidden"),l.disabled=!1,d.disabled=!1}}l.addEventListener("click",async()=>{const e=await v();e&&(await navigator.clipboard.writeText(e),w.textContent+=" — copied to clipboard!")});d.addEventListener("click",async()=>{const e=await v();if(!e)return;const t=E?`${E}-${new Date().toISOString().split("T")[0]}.md`:`slack-export-${new Date().toISOString().split("T")[0]}.md`,n=new Blob([e],{type:"text/markdown"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=t,s.click(),URL.revokeObjectURL(o),w.textContent+=" — downloaded!"});function y(e){r.textContent=e,r.classList.remove("hidden")}async function _(){try{const e=await chrome.runtime.sendMessage({type:"GET_STATUS"});if(!e.hasToken){c.textContent="No Slack session detected. Please open Slack and refresh the page.";return}if(!e.channelId){c.textContent="Please navigate to a Slack channel.";return}p=e.channelId,E=e.channelName||null,B.textContent=e.channelName?`#${e.channelName}`:e.channelId;const t=new Date,n=new Date(t.getTime()-7*24*60*60*1e3);h.value=t.toISOString().split("T")[0],g.value=n.toISOString().split("T")[0],c.classList.add("hidden"),k.classList.remove("hidden")}catch{y("Failed to connect to extension. Try reloading the page.")}}_();
