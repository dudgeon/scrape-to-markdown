import{a as j,S as u,A as y,b as E}from"./constants-DPh_ER4P.js";async function L(){const t=(await chrome.storage.session.get(u.TOKEN))[u.TOKEN];if(!t)throw new Error("No token available. Open Slack and refresh the page.");const n=await chrome.cookies.get({url:"https://app.slack.com",name:"d"});if(!n)throw new Error("No session cookie found. Make sure you are logged into Slack.");return{token:t,cookie:`d=${n.value}`}}async function w(e,t){const{token:n,cookie:r}=await L(),a=await(await fetch(`${j}/${e}`,{method:"POST",headers:{Authorization:`Bearer ${n}`,Cookie:r,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(t).toString()})).json();if(!a.ok)throw a.error==="invalid_auth"||a.error==="token_revoked"?(await chrome.storage.session.remove(u.TOKEN),new Error("AUTH_EXPIRED")):new Error(`Slack API error: ${a.error}`);return a}function R(e){return new Promise(t=>setTimeout(t,e))}async function F(e,t={}){var f,i;const n=[];let r;const o=t.limit;let a=0,c=0;do{const h=o?Math.min(y,o-a):y,s={channel:e,limit:String(h),inclusive:"true"};t.oldest&&(s.oldest=t.oldest),t.latest&&(s.latest=t.latest),r&&(s.cursor=r);const l=await w("conversations.history",s);if(n.push(...l.messages),a+=l.messages.length,r=((f=l.response_metadata)==null?void 0:f.next_cursor)||void 0,c++,(i=t.onPage)==null||i.call(t,c),o&&a>=o)break;r&&await R(E)}while(r);return n.reverse(),o&&n.length>o?n.slice(n.length-o):n}async function H(e,t){var o;const n=[];let r;do{const a={channel:e,ts:t,limit:String(y)};r&&(a.cursor=r);const c=await w("conversations.replies",a);n.push(...c.messages),r=((o=c.response_metadata)==null?void 0:o.next_cursor)||void 0,r&&await R(E)}while(r);return n}async function N(e){return{name:(await w("conversations.info",{channel:e})).channel.name}}async function D(e){const t=await w("users.info",{user:e}),n=t.user.profile;return{displayName:n.display_name||n.real_name||t.user.real_name||e}}let _={},k=!1;async function G(){if(k)return;_=(await chrome.storage.local.get(u.USER_CACHE))[u.USER_CACHE]||{},k=!0}async function B(){await chrome.storage.local.set({[u.USER_CACHE]:_})}async function T(e){await G();const t={},n=[];for(const r of e)_[r]?t[r]=_[r]:n.push(r);for(const r of n){const o=await D(r);_[r]=o.displayName,t[r]=o.displayName}return n.length>0&&await B(),t}function K(e,t){return e.elements.map(n=>Y(n,t)).join(`

`)}function Y(e,t){switch(e.type){case"rich_text_section":return U(e,t);case"rich_text_list":return z(e,t);case"rich_text_preformatted":return Z(e,t);case"rich_text_quote":return Q(e,t);default:return""}}function U(e,t){return e.elements.map(n=>$(n,t)).join("")}function z(e,t){const n="  ".repeat(e.indent||0);return e.elements.map((r,o)=>{const a=U(r,t),c=e.style==="ordered"?`${o+1}.`:"-";return`${n}${c} ${a}`}).join(`
`)}function Z(e,t){return"```\n"+e.elements.map(r=>$(r,t)).join("")+"\n```"}function Q(e,t){return e.elements.map(r=>$(r,t)).join("").split(`
`).map(r=>`> ${r}`).join(`
`)}function $(e,t){switch(e.type){case"text":return v(e.text,e.style);case"link":{const n=e.text?`[${e.text}](${e.url})`:`<${e.url}>`;return e.style?v(n,e.style):n}case"emoji":return`:${e.name}:`;case"user":return`@${t.resolveUser(e.user_id)}`;case"channel":return`#${t.resolveChannel(e.channel_id)}`;case"usergroup":return"@group";case"broadcast":return`@${e.range}`;default:return""}}function v(e,t){if(!t)return e;if(t.code)return`\`${e}\``;let n=e;return t.bold&&t.italic?n=`***${n}***`:t.bold?n=`**${n}**`:t.italic&&(n=`*${n}*`),t.strike&&(n=`~~${n}~~`),n}function P(e,t){let n=e;return n=n.replace(/<@(U[A-Z0-9]+)>/g,(r,o)=>`@${t.resolveUser(o)}`),n=n.replace(/<#(C[A-Z0-9]+)\|([^>]+)>/g,(r,o,a)=>`#${a}`),n=n.replace(/<(https?:\/\/[^|>]+)\|([^>]+)>/g,"[$2]($1)"),n=n.replace(/<(https?:\/\/[^>]+)>/g,"<$1>"),n=n.replace(new RegExp("(?<![`\\\\])\\*([^*\\n]+)\\*(?!`)","g"),"**$1**"),n=n.replace(new RegExp("(?<![`\\\\])_([^_\\n]+)_(?!`)","g"),"*$1*"),n=n.replace(new RegExp("(?<![`\\\\])~([^~\\n]+)~(?!`)","g"),"~~$1~~"),n}function A(e){const t=parseFloat(e)*1e3,n=new Date(t),r=n.toISOString().split("T")[0],o=n.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return{date:r,time:o}}function C(e,t,n=!1){return n?`> **${e}** â€” ${t} (thread reply)`:`**${e}** â€” ${t}`}function X(e){return e.length?`> ${e.map(n=>`:${n.name}: ${n.count}`).join(" Â· ")}`:""}function J(e){const t=e.permalink||e.url_private;return t?`ðŸ“Ž [${e.name}](${t})`:`ðŸ“Ž ${e.name} (no public URL)`}function V(e){return`*${e}*`}function W(e,t){const n=new Date().toISOString().split("T")[0];return[`# #${e}`,"",`Exported from Slack Â· ${n} Â· Messages: ${t}`,"","---"].join(`
`)}const q=new Set(["channel_join","channel_leave","channel_topic","channel_purpose","channel_name","channel_archive"]);function ee(e,t){var f,i,h;const n=s=>t.userMap[s]||s,o={resolveUser:n,resolveChannel:s=>{var l;return((l=t.channelMap)==null?void 0:l[s])||s}},a=[];let c="";a.push(W(t.channelName,e.length));for(const s of e){const{date:l,time:S}=A(s.ts);if(l!==c&&(c=l,a.push(`## ${l}`)),s.subtype&&q.has(s.subtype)){const d=P(s.text,o);a.push(V(d));continue}const p=s.user?n(s.user):s.username||"Unknown";if(a.push(C(p,S)),a.push(M(s,o)),t.includeReactions&&((f=s.reactions)!=null&&f.length)&&a.push(X(s.reactions)),t.includeFiles&&((i=s.files)!=null&&i.length))for(const d of s.files)a.push(J(d));if(t.includeThreadReplies&&s.thread_ts===s.ts&&s.reply_count&&s.reply_count>0){const d=(h=t.threadReplies)==null?void 0:h[s.ts];if(d)for(const g of d.slice(1)){const{time:I}=A(g.ts),b=g.user?n(g.user):g.username||"Unknown";a.push(C(b,I,!0));const x=M(g,o);a.push(x.split(`
`).map(O=>`> ${O}`).join(`
`))}}}return a.join(`

`)}function M(e,t){var r;const n=(r=e.blocks)==null?void 0:r.find(o=>o.type==="rich_text");return n?K(n,t):P(e.text,t)}chrome.runtime.onMessage.addListener((e,t,n)=>(te(e).then(n),!0));async function te(e){switch(e.type){case"GET_STATUS":return ne();case"FETCH_MESSAGES":return re(e);default:return{error:"Unknown message type"}}}async function ne(){const e=await chrome.storage.session.get([u.TOKEN,u.CHANNEL_ID]),t=!!e[u.TOKEN],n=e[u.CHANNEL_ID]||void 0;let r;if(t&&n)try{r=(await N(n)).name}catch{}return{type:"STATUS_RESPONSE",hasToken:t,channelId:n,channelName:r}}function m(e){chrome.runtime.sendMessage({type:"PROGRESS",...e}).catch(()=>{})}async function re(e){try{const t={};e.scope.mode==="last_n"?t.limit=e.scope.count:e.scope.mode==="date_range"&&(t.oldest=String(e.scope.oldest),t.latest=String(e.scope.latest)),m({current:0,phase:"fetching"});const n=await F(e.channelId,{...t,onPage:i=>m({current:i,phase:"fetching"})});m({current:0,phase:"resolving_users"});const r=se(n),o=await T(Array.from(r)),a=await N(e.channelId);let c;if(e.includeThreads){c={};const i=n.filter(s=>s.thread_ts===s.ts&&s.reply_count&&s.reply_count>0);m({current:0,total:i.length,phase:"fetching_threads"});for(let s=0;s<i.length;s++){const l=i[s],S=await H(e.channelId,l.ts);c[l.ts]=S;for(const p of S)p.user&&r.add(p.user);m({current:s+1,total:i.length,phase:"fetching_threads"}),s<i.length-1&&await new Promise(p=>setTimeout(p,E))}const h=await T(Array.from(r));Object.assign(o,h)}return m({current:0,phase:"converting"}),{type:"FETCH_MESSAGES_RESPONSE",success:!0,markdown:ee(n,{channelName:a.name,userMap:o,includeReactions:e.includeReactions??!1,includeFiles:e.includeFiles??!1,includeThreadReplies:e.includeThreads??!1,threadReplies:c}),messageCount:n.length}}catch(t){return{type:"FETCH_MESSAGES_RESPONSE",success:!1,error:t instanceof Error?t.message:String(t)}}}function se(e){const t=new Set;for(const n of e)if(n.user&&t.add(n.user),n.blocks){for(const r of n.blocks)if(r.type==="rich_text"){for(const o of r.elements)if("elements"in o)for(const a of o.elements)a.type==="user"&&t.add(a.user_id)}}return t}
