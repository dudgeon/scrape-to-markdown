import{a as D,S as f,A as k,b as T}from"./constants-I65fpLFJ.js";import{g as G,b as K,a as A}from"./template-storage-CPUsiW84.js";async function B(){const n=(await chrome.storage.session.get(f.TOKEN))[f.TOKEN];if(!n)throw new Error("No token available. Open Slack and refresh the page.");const t=await chrome.cookies.get({url:"https://app.slack.com",name:"d"});if(!t)throw new Error("No session cookie found. Make sure you are logged into Slack.");return{token:n,cookie:`d=${t.value}`}}async function $(e,n){const{token:t,cookie:r}=await B(),o=await(await fetch(`${D}/${e}`,{method:"POST",headers:{Authorization:`Bearer ${t}`,Cookie:r,"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(n).toString()})).json();if(!o.ok)throw o.error==="invalid_auth"||o.error==="token_revoked"?(await chrome.storage.session.remove(f.TOKEN),new Error("AUTH_EXPIRED")):new Error(`Slack API error: ${o.error}`);return o}function I(e){return new Promise(n=>setTimeout(n,e))}async function Y(e,n={}){var h,p;const t=[];let r;const a=n.limit;let o=0,l=0;do{const m=a?Math.min(k,a-o):k,s={channel:e,limit:String(m),inclusive:"true"};n.oldest&&(s.oldest=n.oldest),n.latest&&(s.latest=n.latest),r&&(s.cursor=r);const i=await $("conversations.history",s);if(t.push(...i.messages),o+=i.messages.length,r=((h=i.response_metadata)==null?void 0:h.next_cursor)||void 0,l++,(p=n.onPage)==null||p.call(n,l),a&&o>=a)break;r&&await I(T)}while(r);return t.reverse(),a&&t.length>a?t.slice(t.length-a):t}async function z(e,n){var a;const t=[];let r;do{const o={channel:e,ts:n,limit:String(k)};r&&(o.cursor=r);const l=await $("conversations.replies",o);t.push(...l.messages),r=((a=l.response_metadata)==null?void 0:a.next_cursor)||void 0,r&&await I(T)}while(r);return t}async function b(e){var r,a;const t=(await $("conversations.info",{channel:e})).channel;return{id:t.id,name:t.name,is_channel:t.is_channel,is_group:t.is_group,is_im:t.is_im,is_mpim:t.is_mpim,is_private:t.is_private,topic:((r=t.topic)==null?void 0:r.value)||"",purpose:((a=t.purpose)==null?void 0:a.value)||""}}async function Q(){const e=await $("team.info",{});return{name:e.team.name,domain:e.team.domain}}async function X(e){const n=await $("users.info",{user:e}),t=n.user.profile;return{displayName:t.display_name||t.real_name||n.user.real_name||e}}let y={},C=!1;async function Z(){if(C)return;y=(await chrome.storage.local.get(f.USER_CACHE))[f.USER_CACHE]||{},C=!0}async function J(){await chrome.storage.local.set({[f.USER_CACHE]:y})}async function M(e){await Z();const n={},t=[];for(const r of e)y[r]?n[r]=y[r]:t.push(r);for(const r of t){const a=await X(r);y[r]=a.displayName,n[r]=a.displayName}return t.length>0&&await J(),n}function V(e,n){return e.elements.map(t=>W(t,n)).join(`

`)}function W(e,n){switch(e.type){case"rich_text_section":return P(e,n);case"rich_text_list":return q(e,n);case"rich_text_preformatted":return ee(e,n);case"rich_text_quote":return te(e,n);default:return""}}function P(e,n){return e.elements.map(t=>v(t,n)).join("")}function q(e,n){const t="  ".repeat(e.indent||0);return e.elements.map((r,a)=>{const o=P(r,n),l=e.style==="ordered"?`${a+1}.`:"-";return`${t}${l} ${o}`}).join(`
`)}function ee(e,n){return"```\n"+e.elements.map(r=>v(r,n)).join("")+"\n```"}function te(e,n){return e.elements.map(r=>v(r,n)).join("").split(`
`).map(r=>`> ${r}`).join(`
`)}function v(e,n){switch(e.type){case"text":return N(e.text,e.style);case"link":{const t=e.text?`[${e.text}](${e.url})`:`<${e.url}>`;return e.style?N(t,e.style):t}case"emoji":return`:${e.name}:`;case"user":return`@${n.resolveUser(e.user_id)}`;case"channel":return`#${n.resolveChannel(e.channel_id)}`;case"usergroup":return"@group";case"broadcast":return`@${e.range}`;default:return""}}function N(e,n){if(!n)return e;if(n.code)return`\`${e}\``;let t=e;return n.bold&&n.italic?t=`***${t}***`:n.bold?t=`**${t}**`:n.italic&&(t=`*${t}*`),n.strike&&(t=`~~${t}~~`),t}function x(e,n){let t=e;return t=t.replace(/<@(U[A-Z0-9]+)>/g,(r,a)=>`@${n.resolveUser(a)}`),t=t.replace(/<#(C[A-Z0-9]+)\|([^>]+)>/g,(r,a,o)=>`#${o}`),t=t.replace(/<(https?:\/\/[^|>]+)\|([^>]+)>/g,"[$2]($1)"),t=t.replace(/<(https?:\/\/[^>]+)>/g,"<$1>"),t=t.replace(new RegExp("(?<![`\\\\])\\*([^*\\n]+)\\*(?!`)","g"),"**$1**"),t=t.replace(new RegExp("(?<![`\\\\])_([^_\\n]+)_(?!`)","g"),"*$1*"),t=t.replace(new RegExp("(?<![`\\\\])~([^~\\n]+)~(?!`)","g"),"~~$1~~"),t}function R(e){const n=parseFloat(e)*1e3,t=new Date(n),r=t.toISOString().split("T")[0],a=t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return{date:r,time:a}}function ne(e,n){return`**${e}** â€” ${n}`}const U=80;function re(e,n,t,r){const a=r.length>U?r.slice(0,U)+"â€¦":r;return`> **Thread** (${e} ${e===1?"reply":"replies"} to ${n} â€” ${t}: â€œ${a}â€):`}function se(e){return e.length?`> ${e.map(t=>`:${t.name}: ${t.count}`).join(" Â· ")}`:""}function ae(e){const n=e.permalink||e.url_private;return n?`ðŸ“Ž [${e.name}](${n})`:`ðŸ“Ž ${e.name} (no public URL)`}function oe(e){return`*${e}*`}function ce(e,n){const t=new Date().toISOString().split("T")[0];return[`# #${e}`,"",`Exported from Slack Â· ${t} Â· Messages: ${n}`,"","---"].join(`
`)}const ie=new Set(["channel_join","channel_leave","channel_topic","channel_purpose","channel_name","channel_archive"]);function le(e,n){var h,p,m;const t=s=>n.userMap[s]||s,a={resolveUser:t,resolveChannel:s=>{var i;return((i=n.channelMap)==null?void 0:i[s])||s}},o=[];let l="";n.skipDocumentHeader||o.push(ce(n.channelName,e.length));for(const s of e){const{date:i,time:c}=R(s.ts);if(i!==l&&(l=i,o.push(`## ${i}`)),s.subtype&&ie.has(s.subtype)){const u=x(s.text,a);o.push(oe(u));continue}const d=s.user?t(s.user):s.username||"Unknown";if(o.push(ne(d,c)),o.push(E(s,a)),n.includeReactions&&((h=s.reactions)!=null&&h.length)&&o.push(se(s.reactions)),n.includeFiles&&((p=s.files)!=null&&p.length))for(const u of s.files)o.push(ae(u));if(n.includeThreadReplies&&s.thread_ts===s.ts&&s.reply_count&&s.reply_count>0){const u=(m=n.threadReplies)==null?void 0:m[s.ts];if(u&&u.length>1){const g=E(s,a),O=u.length-1,S=[];S.push(re(O,d,c,g));for(const w of u.slice(1)){const{time:F}=R(w.ts),H=w.user?t(w.user):w.username||"Unknown";S.push(">"),S.push(`> **${H}** â€” ${F}`);const j=E(w,a);for(const L of j.split(`
`))S.push(`> ${L}`)}o.push(S.join(`
`))}}}return o.join(`

`)}function E(e,n){var r;const t=(r=e.blocks)==null?void 0:r.find(a=>a.type==="rich_text");return t?V(t,n):x(e.text,n)}chrome.runtime.onMessage.addListener((e,n,t)=>(ue(e).then(t),!0));async function ue(e){switch(e.type){case"GET_STATUS":return fe();case"FETCH_MESSAGES":return he(e);default:return{error:"Unknown message type"}}}async function fe(){const e=await chrome.storage.session.get([f.TOKEN,f.CHANNEL_ID]),n=!!e[f.TOKEN],t=e[f.CHANNEL_ID]||void 0;let r;if(n&&t)try{r=(await b(t)).name}catch{}return{type:"STATUS_RESPONSE",hasToken:n,channelId:t,channelName:r}}function _(e){chrome.runtime.sendMessage({type:"PROGRESS",...e}).catch(()=>{})}async function he(e){try{const n={};e.scope.mode==="last_n"?n.limit=e.scope.count:e.scope.mode==="date_range"&&(n.oldest=String(e.scope.oldest),n.latest=String(e.scope.latest)),_({current:0,phase:"fetching"});const t=await Y(e.channelId,{...n,onPage:s=>_({current:s,phase:"fetching"})});_({current:0,phase:"resolving_users"});const r=pe(t),a=await M(Array.from(r)),o=await b(e.channelId);let l;if(e.includeThreads){l={};const s=t.filter(c=>c.thread_ts===c.ts&&c.reply_count&&c.reply_count>0);_({current:0,total:s.length,phase:"fetching_threads"});for(let c=0;c<s.length;c++){const d=s[c],u=await z(e.channelId,d.ts);l[d.ts]=u;for(const g of u)g.user&&r.add(g.user);_({current:c+1,total:s.length,phase:"fetching_threads"}),c<s.length-1&&await new Promise(g=>setTimeout(g,T))}const i=await M(Array.from(r));Object.assign(a,i)}_({current:0,phase:"converting"});const h=e.includeFrontmatter??!1,p=le(t,{channelName:o.name,userMap:a,includeReactions:e.includeReactions??!1,includeFiles:e.includeFiles??!1,includeThreadReplies:e.includeThreads??!1,threadReplies:l,skipDocumentHeader:h});let m=p;if(h){let s={name:"",domain:""};try{s=await Q()}catch{}const i={channel:o,workspaceName:s.name,workspaceDomain:s.domain,messages:t,messageCount:t.length,scope:e.scope};let c;try{const d=await G("slack");d?c=K(d,i):c=A(i)}catch{c=A(i)}m=c+`

`+p}return{type:"FETCH_MESSAGES_RESPONSE",success:!0,markdown:m,messageCount:t.length}}catch(n){return{type:"FETCH_MESSAGES_RESPONSE",success:!1,error:n instanceof Error?n.message:String(n)}}}function pe(e){const n=new Set;for(const t of e)if(t.user&&n.add(t.user),t.blocks){for(const r of t.blocks)if(r.type==="rich_text"){for(const a of r.elements)if("elements"in a)for(const o of a.elements)o.type==="user"&&n.add(o.user_id)}}return n}
