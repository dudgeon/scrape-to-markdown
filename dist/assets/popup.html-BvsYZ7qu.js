(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))r(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function o(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function r(t){if(t.ep)return;t.ep=!0;const s=o(t);fetch(t.href,s)}})();const l=document.getElementById("status"),L=document.getElementById("controls"),S=document.getElementById("channel-name"),B=document.getElementById("message-count"),a=document.getElementById("copy-btn"),d=document.getElementById("download-btn"),I=document.getElementById("result"),w=document.getElementById("result-message"),i=document.getElementById("error"),u=document.getElementById("progress"),m=document.getElementById("progress-fill"),g=document.getElementById("progress-text"),b=document.getElementById("last-n-options"),x=document.getElementById("date-range-options"),h=document.getElementById("date-from"),p=document.getElementById("date-to"),T=document.getElementById("include-threads"),k=document.getElementById("include-reactions"),C=document.getElementById("include-files");let f=null,y=null,O=null;const $=document.querySelectorAll('input[name="scope"]');$.forEach(e=>{e.addEventListener("change",()=>{const n=e.value;b.classList.toggle("hidden",n!=="last_n"),x.classList.toggle("hidden",n!=="date_range")})});chrome.runtime.onMessage.addListener(e=>{if(e.type!=="PROGRESS")return;u.classList.remove("hidden");const o={fetching:"Fetching messages",resolving_users:"Resolving users",fetching_threads:"Fetching threads",converting:"Converting to markdown"}[e.phase]||e.phase;if(e.total){const r=Math.round(e.current/e.total*100);m.style.width=`${r}%`,g.textContent=`${o}: ${e.current}/${e.total}`}else m.style.width="",g.textContent=e.current>0?`${o} (page ${e.current})...`:`${o}...`});function R(){const e=document.querySelector('input[name="scope"]:checked').value;if(e==="date_range"){const n=h.value?new Date(h.value).getTime()/1e3:0,o=p.value?new Date(p.value+"T23:59:59").getTime()/1e3:Date.now()/1e3;return{mode:"date_range",oldest:n,latest:o}}return e==="all"?{mode:"all"}:{mode:"last_n",count:parseInt(B.value,10)}}async function v(){if(!f)return null;I.classList.add("hidden"),i.classList.add("hidden"),u.classList.remove("hidden"),m.style.width="0%",g.textContent="Starting...",a.disabled=!0,d.disabled=!0;try{const e=await chrome.runtime.sendMessage({type:"FETCH_MESSAGES",channelId:f,scope:R(),includeThreads:T.checked,includeReactions:k.checked,includeFiles:C.checked});return!e.success||!e.markdown?(E(e.error||"Export failed"),null):(O=e.markdown,w.textContent=`Exported ${e.messageCount} messages`,I.classList.remove("hidden"),e.markdown)}catch(e){return E(e instanceof Error?e.message:"Unknown error"),null}finally{u.classList.add("hidden"),a.disabled=!1,d.disabled=!1}}a.addEventListener("click",async()=>{const e=await v();e&&(await navigator.clipboard.writeText(e),w.textContent+=" — copied to clipboard!")});d.addEventListener("click",async()=>{const e=await v();if(!e)return;const n=y?`${y}-${new Date().toISOString().split("T")[0]}.md`:`slack-export-${new Date().toISOString().split("T")[0]}.md`,o=new Blob([e],{type:"text/markdown"}),r=URL.createObjectURL(o),t=document.createElement("a");t.href=r,t.download=n,t.click(),URL.revokeObjectURL(r),w.textContent+=" — downloaded!"});function E(e){i.textContent=e,i.classList.remove("hidden")}async function N(){try{const e=await chrome.runtime.sendMessage({type:"GET_STATUS"});if(!e.hasToken){l.textContent="No Slack session detected. Please open Slack and refresh the page.";return}if(!e.channelId){l.textContent="Please navigate to a Slack channel.";return}f=e.channelId,y=e.channelName||null,S.textContent=e.channelName?`#${e.channelName}`:e.channelId;const n=new Date,o=new Date(n.getTime()-7*24*60*60*1e3);p.value=n.toISOString().split("T")[0],h.value=o.toISOString().split("T")[0],l.classList.add("hidden"),L.classList.remove("hidden")}catch{E("Failed to connect to extension. Try reloading the page.")}}N();
