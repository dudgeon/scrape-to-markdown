import{a as G,A as v,b as C,S as h}from"./constants-I65fpLFJ.js";import{g as q,b as W,a as x,i as X,E as Y,c as z}from"./frontmatter-BOATe5ZA.js";let E,b;function Q(e,n){E=e,b=n}async function k(e,n){const t=await E.getToken();if(!t)throw new Error("No token available. Open Slack and refresh the page.");const r=await E.getCookie();if(!r)throw new Error("No session cookie found. Make sure you are logged into Slack.");const a=await(await b.post(`${G}/${e}`,{Authorization:`Bearer ${t}`,Cookie:r,"Content-Type":"application/x-www-form-urlencoded"},new URLSearchParams(n).toString())).json();if(!a.ok)throw a.error==="invalid_auth"||a.error==="token_revoked"?(await E.clearToken(),new Error("AUTH_EXPIRED")):new Error(`Slack API error: ${a.error}`);return a}function D(e){return new Promise(n=>setTimeout(n,e))}async function Z(e,n={}){var f,d;const t=[];let r;const s=n.limit;let a=0,i=0;do{const g=s?Math.min(v,s-a):v,c={channel:e,limit:String(g),inclusive:"true"};n.oldest&&(c.oldest=n.oldest),n.latest&&(c.latest=n.latest),r&&(c.cursor=r);const u=await k("conversations.history",c);if(t.push(...u.messages),a+=u.messages.length,r=((f=u.response_metadata)==null?void 0:f.next_cursor)||void 0,i++,(d=n.onPage)==null||d.call(n,i),s&&a>=s)break;r&&await D(C)}while(r);return t.reverse(),s&&t.length>s?t.slice(t.length-s):t}async function J(e,n){var s;const t=[];let r;do{const a={channel:e,ts:n,limit:String(v)};r&&(a.cursor=r);const i=await k("conversations.replies",a);t.push(...i.messages),r=((s=i.response_metadata)==null?void 0:s.next_cursor)||void 0,r&&await D(C)}while(r);return t}async function H(e){var r,s;const t=(await k("conversations.info",{channel:e})).channel;return{id:t.id,name:t.name,is_channel:t.is_channel,is_group:t.is_group,is_im:t.is_im,is_mpim:t.is_mpim,is_private:t.is_private,topic:((r=t.topic)==null?void 0:r.value)||"",purpose:((s=t.purpose)==null?void 0:s.value)||""}}async function V(){const e=await k("team.info",{});return{name:e.team.name,domain:e.team.domain}}async function ee(e){const n=await k("users.info",{user:e}),t=n.user.profile;return{displayName:t.display_name||t.real_name||n.user.real_name||e}}let N,T={},I=!1;function te(e){N=e}async function ne(){I||(T=await N.get(h.USER_CACHE)||{},I=!0)}async function re(){await N.set(h.USER_CACHE,T)}async function M(e){await ne();const n={},t=[];for(const r of e)T[r]?n[r]=T[r]:t.push(r);for(const r of t){const s=await ee(r);T[r]=s.displayName,n[r]=s.displayName}return t.length>0&&await re(),n}class se{async getToken(){return(await chrome.storage.session.get(h.TOKEN))[h.TOKEN]}async getCookie(){const n=await chrome.cookies.get({url:"https://app.slack.com",name:"d"});return n?`d=${n.value}`:void 0}async clearToken(){await chrome.storage.session.remove(h.TOKEN)}}class ae{async post(n,t,r){return fetch(n,{method:"POST",headers:t,body:r})}}function ce(e,n){return e.elements.map(t=>oe(t,n)).join(`

`)}function oe(e,n){switch(e.type){case"rich_text_section":return L(e,n);case"rich_text_list":return ie(e,n);case"rich_text_preformatted":return le(e,n);case"rich_text_quote":return ue(e,n);default:return""}}function L(e,n){return e.elements.map(t=>R(t,n)).join("")}function ie(e,n){const t="  ".repeat(e.indent||0);return e.elements.map((r,s)=>{const a=L(r,n),i=e.style==="ordered"?`${s+1}.`:"-";return`${t}${i} ${a}`}).join(`
`)}function le(e,n){return"```\n"+e.elements.map(r=>R(r,n)).join("")+"\n```"}function ue(e,n){return e.elements.map(r=>R(r,n)).join("").split(`
`).map(r=>`> ${r}`).join(`
`)}function R(e,n){switch(e.type){case"text":return P(e.text,e.style);case"link":{const t=e.text?`[${e.text}](${e.url})`:`<${e.url}>`;return e.style?P(t,e.style):t}case"emoji":return`:${e.name}:`;case"user":return`@${n.resolveUser(e.user_id)}`;case"channel":return`#${n.resolveChannel(e.channel_id)}`;case"usergroup":return"@group";case"broadcast":return`@${e.range}`;default:return""}}function P(e,n){if(!n)return e;if(n.code)return`\`${e}\``;let t=e;return n.bold&&n.italic?t=`***${t}***`:n.bold?t=`**${t}**`:n.italic&&(t=`*${t}*`),n.strike&&(t=`~~${t}~~`),t}function F(e,n){let t=e;return t=t.replace(/<@(U[A-Z0-9]+)>/g,(r,s)=>`@${n.resolveUser(s)}`),t=t.replace(/<#(C[A-Z0-9]+)\|([^>]+)>/g,(r,s,a)=>`#${a}`),t=t.replace(/<(https?:\/\/[^|>]+)\|([^>]+)>/g,"[$2]($1)"),t=t.replace(/<(https?:\/\/[^>]+)>/g,"<$1>"),t=t.replace(new RegExp("(?<![`\\\\])\\*([^*\\n]+)\\*(?!`)","g"),"**$1**"),t=t.replace(new RegExp("(?<![`\\\\])_([^_\\n]+)_(?!`)","g"),"*$1*"),t=t.replace(new RegExp("(?<![`\\\\])~([^~\\n]+)~(?!`)","g"),"~~$1~~"),t}function U(e){const n=parseFloat(e)*1e3,t=new Date(n),r=t.toISOString().split("T")[0],s=t.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return{date:r,time:s}}function he(e,n){return`**${e}** â€” ${n}`}const O=80;function fe(e,n,t,r){const s=r.length>O?r.slice(0,O)+"â€¦":r;return`> **Thread** (${e} ${e===1?"reply":"replies"} to ${n} â€” ${t}: â€œ${s}â€):`}function de(e){return e.length?`> ${e.map(t=>`:${t.name}: ${t.count}`).join(" Â· ")}`:""}function me(e){const n=e.permalink||e.url_private;return n?`ðŸ“Ž [${e.name}](${n})`:`ðŸ“Ž ${e.name} (no public URL)`}function pe(e){return`*${e}*`}function ge(e,n){const t=new Date().toISOString().split("T")[0];return[`# #${e}`,"",`Exported from Slack Â· ${t} Â· Messages: ${n}`,"","---"].join(`
`)}const _e=new Set(["channel_join","channel_leave","channel_topic","channel_purpose","channel_name","channel_archive"]);function we(e,n){var f,d,g;const t=c=>n.userMap[c]||c,s={resolveUser:t,resolveChannel:c=>{var u;return((u=n.channelMap)==null?void 0:u[c])||c}},a=[];let i="";n.skipDocumentHeader||a.push(ge(n.channelName,e.length));for(const c of e){const{date:u,time:S}=U(c.ts);if(u!==i&&(i=u,a.push(`## ${u}`)),c.subtype&&_e.has(c.subtype)){const o=F(c.text,s);a.push(pe(o));continue}const y=c.user?t(c.user):c.username||"Unknown";if(a.push(he(y,S)),a.push($(c,s)),n.includeReactions&&((f=c.reactions)!=null&&f.length)&&a.push(de(c.reactions)),n.includeFiles&&((d=c.files)!=null&&d.length))for(const o of c.files)a.push(me(o));if(n.includeThreadReplies&&c.thread_ts===c.ts&&c.reply_count&&c.reply_count>0){const o=(g=n.threadReplies)==null?void 0:g[c.ts];if(o&&o.length>1){const p=$(c,s),l=o.length-1,m=[];m.push(fe(l,y,S,p));for(const _ of o.slice(1)){const{time:w}=U(_.ts),j=_.user?t(_.user):_.username||"Unknown";m.push(">"),m.push(`> **${j}** â€” ${w}`);const B=$(_,s);for(const K of B.split(`
`))m.push(`> ${K}`)}a.push(m.join(`
`))}}}return a.join(`

`)}function $(e,n){var r;const t=(r=e.blocks)==null?void 0:r.find(s=>s.type==="rich_text");return t?ce(t,n):F(e.text,n)}async function Se(e){var g,c,u,S,y;const n={};e.scope.mode==="last_n"?n.limit=e.scope.count:e.scope.mode==="date_range"&&(n.oldest=String(e.scope.oldest),n.latest=String(e.scope.latest)),(g=e.onProgress)==null||g.call(e,{current:0,phase:"fetching"});const t=await Z(e.channelId,{...n,onPage:o=>{var p;return(p=e.onProgress)==null?void 0:p.call(e,{current:o,phase:"fetching"})}});(c=e.onProgress)==null||c.call(e,{current:0,phase:"resolving_users"});const r=ye(t),s=await M(Array.from(r)),a=await H(e.channelId);let i;if(e.includeThreads){i={};const o=t.filter(l=>l.thread_ts===l.ts&&l.reply_count&&l.reply_count>0);(u=e.onProgress)==null||u.call(e,{current:0,total:o.length,phase:"fetching_threads"});for(let l=0;l<o.length;l++){const m=o[l],_=await J(e.channelId,m.ts);i[m.ts]=_;for(const w of _)w.user&&r.add(w.user);(S=e.onProgress)==null||S.call(e,{current:l+1,total:o.length,phase:"fetching_threads"}),l<o.length-1&&await new Promise(w=>setTimeout(w,C))}const p=await M(Array.from(r));Object.assign(s,p)}(y=e.onProgress)==null||y.call(e,{current:0,phase:"converting"});const f=we(t,{channelName:a.name,userMap:s,includeReactions:e.includeReactions,includeFiles:e.includeFiles,includeThreadReplies:e.includeThreads,threadReplies:i,skipDocumentHeader:e.includeFrontmatter});let d=f;if(e.includeFrontmatter){let o={name:"",domain:""};try{o=await V()}catch{}const p={channel:a,workspaceName:o.name,workspaceDomain:o.domain,messages:t,messageCount:t.length,scope:e.scope};let l;try{const m=await q("slack");m?l=W(m,p):l=x(p)}catch{l=x(p)}d=l+`

`+f}return{markdown:d,messageCount:t.length}}function ye(e){const n=new Set;for(const t of e)if(t.user&&n.add(t.user),t.blocks){for(const r of t.blocks)if(r.type==="rich_text"){for(const s of r.elements)if("elements"in s)for(const a of s.elements)a.type==="user"&&n.add(a.user_id)}}return n}Q(new se,new ae);te(new z);X(new Y);chrome.storage.session.setAccessLevel({accessLevel:"TRUSTED_AND_UNTRUSTED_CONTEXTS"});function A(e){chrome.storage.session.set({[h.TOKEN]:e})}chrome.webRequest.onBeforeSendHeaders.addListener(e=>{var n;if(e.requestHeaders){for(const t of e.requestHeaders)if(t.name.toLowerCase()==="authorization"&&((n=t.value)!=null&&n.startsWith("Bearer xoxc-"))){A(t.value.slice(7));return}}},{urls:["https://slack.com/api/*","https://edgeapi.slack.com/*"]},["requestHeaders"]);chrome.webRequest.onBeforeRequest.addListener(e=>{var r,s,a,i,f,d;const n=(a=(s=(r=e.requestBody)==null?void 0:r.formData)==null?void 0:s.token)==null?void 0:a[0];if(typeof n=="string"&&n.startsWith("xoxc-")){A(n);return}const t=(d=(f=(i=e.requestBody)==null?void 0:i.raw)==null?void 0:f[0])==null?void 0:d.bytes;if(t)try{const g=new TextDecoder().decode(t),c=JSON.parse(g);typeof c.token=="string"&&c.token.startsWith("xoxc-")&&A(c.token)}catch{}},{urls:["https://slack.com/api/*","https://edgeapi.slack.com/*"]},["requestBody"]);chrome.runtime.onMessage.addListener((e,n,t)=>(Te(e).then(t),!0));async function Te(e){switch(e.type){case"EXTRACT_TOKEN":return;case"CHANNEL_DETECTED":await chrome.storage.session.set({[h.CHANNEL_ID]:e.channelId,[h.WORKSPACE_ID]:e.workspaceId});return;case"GET_STATUS":return ke(e);case"FETCH_MESSAGES":return Ee(e);default:return{error:"Unknown message type"}}}async function ke(e){const n=await chrome.storage.session.get([h.TOKEN,h.CHANNEL_ID]),t=!!n[h.TOKEN],r=e.channelId||n[h.CHANNEL_ID]||void 0;let s;if(t&&r)try{s=(await H(r)).name}catch{}return{type:"STATUS_RESPONSE",hasToken:t,channelId:r,channelName:s}}async function Ee(e){try{const n=await Se({channelId:e.channelId,scope:e.scope,includeThreads:e.includeThreads??!1,includeReactions:e.includeReactions??!1,includeFiles:e.includeFiles??!1,includeFrontmatter:e.includeFrontmatter??!1,onProgress:t=>{chrome.runtime.sendMessage({type:"PROGRESS",...t}).catch(()=>{})}});return{type:"FETCH_MESSAGES_RESPONSE",success:!0,markdown:n.markdown,messageCount:n.messageCount}}catch(n){return{type:"FETCH_MESSAGES_RESPONSE",success:!1,error:n instanceof Error?n.message:String(n)}}}
